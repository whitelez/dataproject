{% extends "traffic/base.html" %}

{% load staticfiles %}

{% block title %}
Power of 32 RTIS - Travel Time: Corridors (2013-2015)
{% endblock %}

{% block style %}
<link rel="stylesheet" href="http://leafletjs.com/dist/leaflet.css" xmlns="http://www.w3.org/1999/html">
<link rel="stylesheet" href="{% static 'traffic/leaflet-search.css' %}">
<link rel="stylesheet" href="{% static 'traffic/jquery.jqplot.min.css' %}">
<link rel="stylesheet" href="{% static 'traffic/bootstrap-datetimepicker.min.css' %}" />
<link rel="stylesheet" href="{% static 'traffic/bootstrap-switch.min.css' %}" />
{% endblock %}


{% block content %}

<div class="well" id="inputframe" style="height:600px;">
	<div class="container" style="width: inherit">
        <div class="row"><h3>Travel Time </h3></div>
        <div class="row"><h4> Corridors (2013-2015): </h4></div>
	    <div class="row" style="padding-top:5px;">
		   <div class="col-md-4" style="height: 36px;padding-right: 0;"><h5>Corridor:</h5></div>
		   <div class="col-md-8" style="padding-left: 0;">
               <select id="cor" name="cor"  class="selectpicker show-tick show-menu-arrow" data-live-search="true" data-width="100%">
				    {% for corridor in corridors%}
					    <option value={{corridor.Corridor_Number}}>Corridor {{corridor.Corridor_Number}} - {{corridor.Corridor_Name}}</option>
			 	    {% endfor %}
		 	   </select>
           </div>
	    </div>
	    <div class="row" style="padding-top:5px;">
            <div class="col-md-4" style="height: 36px;padding-right: 0;"><h5>Start Node:</h5></div>
            <div class="col-md-8" style="padding-left: 0;">
               <select id="SNode" name="SNode" class="selectpicker show-tick show-menu-arrow" data-live-search="true" data-width="100%">    </select>
            </div>
        </div>
        <div class="row" style="padding-top:5px;">
           <div class="col-md-4" style="height: 36px;padding-right: 0;"><h5>End Node:</h5></div>
           <div class="col-md-8" style="padding-left: 0;">
               <select id="ENode" name="ENode" class="selectpicker show-tick show-menu-arrow" data-live-search="true" data-width="100%">    </select>
           </div>
        </div>
    	<div class="row" style="padding-top:5px;">
           <div class="col-md-4" style="height: 36px;padding-right: 0;"><h5>Start Time:</h5></div>
           <div class="col-md-8" style="padding-left: 0;">
                    <div class='input-group date' id='datetimepicker'>
                        <input id="Stime" type='text' style="height: 36px;width: 145px;" class="form-control" />
                        <span class="input-group-addon" style="height: 36px;width: 36px;padding: 0;"><span class="glyphicon glyphicon-time"></span>
                        </span>
                    </div>
           </div>
        </div>
        <div class="row" style="padding-top:5px;">
           <div class="col-md-4" style="height: 36px;padding-right: 0;"><h5>End Time:</h5></div>
           <div class="col-md-8" style="padding-left: 0;">
                    <div class='input-group date' id='datetimepicker2'>
                        <input id="Etime" style="height: 36px;width: 145px;" type='text' class="form-control" />
                        <span class="input-group-addon" style="height: 36px;width: 36px;padding: 0;"><span class="glyphicon glyphicon-time"></span>
                        </span>
                    </div>
           </div>
        </div>
        <div class="row" style="padding-top: 5px;">
            <div class="col-md-6" style="padding-right: 0;">
                    <input type="checkbox" id="checkboxTTI" name="checkboxTTI" value="TTI" checked>
            </div>
            <div class="col-md-6" style="padding-left: 0;">
                    <input type="checkbox" id="checkboxBT" name="checkboxBT" value="BT" checked>
            </div>
        </div>
        <div class="row" style="padding-top: 5px;">
            <div class="col-md-6" style="padding-right: 0;">
                    <input type="checkbox" id="checkboxBI" name="checkboxBI" value="BI" checked>
            </div>
            <div class="col-md-6" style="padding-left: 0;">
                    <input type="checkbox" id="checkboxPTI" name="checkboxPTI" value="PTI" checked>
            </div>
        </div>
    </div>

	<button type="button" style="margin-top:10px;" class="btn btn-default btn-block" id="spcshow">
        <span class="glyphicon glyphicon-search"> </span> &nbsp; Update
    </button> <br>

	<div style="width:100%;height:2px;margin:0 auto;padding:0;background-color:#ddd;overflow:hidden;"></div> <br>

	<div class="container" style="width: inherit">
    	<div class="row"><h4> Results: </h4></div>
    	<div class="row" style="margin-top: 5px;">
           <div class="col-md-6" style="height: auto;padding-right: 0;">
               Average Traveltime:
           </div>
           <div class="col-md-6" style="height: auto;padding-left: 0;">
               <span id = 'spctravel_time_car'>&emsp;&emsp;&emsp;</span>
           </div>
        </div>
    	<div class="row" style="margin-top: 10px;">
           <div class="col-md-6" style="height: auto;padding-right: 0;">
               <p>Delay per Vehicle:</p>
           </div>
           <div class="col-md-6" style="height: auto;padding-left: 0;">
               <span id = 'spctravel_delay'>&emsp;&emsp;&emsp;</span>
           </div>
        </div>
    </div>

</div>
{% endblock %}

{% block map %}
	<div id="map"></div>

    <div id="chartcontainer">
     	<div id="chart1" style="height:auto;width:97%;margin-left: 20px;margin-right: 20px;margin-top: 20px; "></div>
        <div id="chart2" style="height:auto;width:97%;margin-left: 20px;margin-right: 20px;margin-top: 20px; "></div>
        <div id="chartTTI" style="height:auto;width:97%;margin-left: 20px;margin-right: 20px;margin-top: 20px; "></div>
        <div id="chartBT" style="height:auto;width:97%;margin-left: 20px;margin-right: 20px;margin-top: 20px; "></div>
        <div id="chartBI" style="height:auto;width:97%;margin-left: 20px;margin-right: 20px;margin-top: 20px; "></div>
        <div id="chartPTI" style="height:auto;width:97%;margin-left: 20px;margin-right: 20px;margin-top: 20px; "></div>
	</div>
{% endblock %}
	
	

{% block script %}
<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
<script type="text/javascript" src="{% static 'traffic/leaflet-search.min.js' %}"></script>
<script type="text/javascript" src="{% static 'traffic/TMC_geojson.js' %}"></script>
<script type="text/javascript" src="{% static 'traffic/jquery.jqplot.min.js' %}"></script>
<script type="text/javascript" src="{% static 'traffic/jqplot.dateAxisRenderer.min.js' %}"></script>
<script type="text/javascript" src="{% static 'traffic/jqplot.pointLabels.min.js' %}"></script>

<script type="text/javascript" src="{% static 'traffic/moment.min.js' %}"></script>
<script type="text/javascript" src="{% static 'traffic/bootstrap-3.3.2/js/transition.js' %}"></script>
<script type="text/javascript" src="{% static 'traffic/bootstrap-3.3.2/js/collapse.js' %}"></script>
<script type="text/javascript" src="{% static 'traffic/bootstrap-datetimepicker.min.js' %}"></script>
<script type="text/javascript" src="{% static 'traffic/bootstrap-switch.min.js' %}"></script>


<script type="text/javascript">
    var options = {
        onColor: 'info',
        offColor: 'warning',
        labelText: 'TTI',
        labelWidth: 50
    };
    $("[name='checkboxTTI']").bootstrapSwitch(options);
    options.labelText = 'BT';
    $("[name='checkboxBT']").bootstrapSwitch(options);
    options.labelText = 'BI';
    $("[name='checkboxBI']").bootstrapSwitch(options);
    options.labelText = 'PTI';
    $("[name='checkboxPTI']").bootstrapSwitch(options);
</script>

<script type="text/javascript">
      $(function () {
          $('#datetimepicker').datetimepicker({
              format: 'LT'
          });
      });
      $(function () {
          $('#datetimepicker2').datetimepicker({
              format: 'LT'
          });
      });
</script>

<script>
     $('.selectpicker').selectpicker({
      style: 'btn-inverse',
      size: 10
     });
</script>

<script>
	$(function(){
	var map = L.map('map').setView([40.4407937, -80.0029874], 10);
    var nodelayer, Snodelayer, Enodelayer;
    var nodes;
    
	// add an OpenStreetMap tile layer
	var basemap = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
		attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
	}).addTo(map);
	
	control = L.control.layers({'Base Map':basemap},null,{collapsed:false}).addTo(map);
	
	map.addControl( new L.Control.Search({
			url: 'http://nominatim.openstreetmap.org/search?format=json&q={s}',
			jsonpParam: 'json_callback',
			propertyName: 'display_name',
			propertyLoc: ['lat','lon'],
			markerLocation: true,
			autoType: false,
			autoCollapse: true,
			minLength: 2,
			zoom:10
		}) );

{#======================================================================================================================#}
                                            {#  NODE-BASED DATA: BY PXD #}

    var geojsonMarkerOptions = {
        radius: 8,
        fillColor: "blue",
        color: "blue",
        weight: 5,
        opacity: 0.3,
        fillOpacity: 0.5
    };

    function corchange(cornum){
        $('#SNode').empty();
        $('#ENode').empty();
        $('#spctravel_time_car').text('');
		$('#spctravel_delay').text('');
        $("#chart").empty();
        if(nodelayer){
					control.removeLayer(nodelayer);
					if(map.hasLayer(nodelayer)){
						map.removeLayer(nodelayer);
					}
				}
        if(Snodelayer){
					control.removeLayer(Snodelayer);
					if(map.hasLayer(Snodelayer)){
						map.removeLayer(Snodelayer);
					}
				}
        if(Enodelayer){
					control.removeLayer(Enodelayer);
					if(map.hasLayer(Enodelayer)){
						map.removeLayer(Enodelayer);
					}
				}
        $.get('../get_node_info_2013to2015/', {cornum:cornum}, function(data, textStatus){
            nodes = $.parseJSON(data);
            var latmean, longmean;
            latmean = 0;
            longmean = 0;
            $('#SNode').append("<option selected='selected'></option>");
            $('#ENode').append("<option selected='selected'></option>");
            for (var i=0;i<nodes.features.length;i++){
                $('#SNode').append("<option value="+nodes.features[i].properties.Node_Number + ">" + nodes.features[i].properties.Node_Number + " - " + nodes.features[i].properties.Node_Name + "</option>");
                $('#SNode').selectpicker('refresh');
                $('#ENode').append("<option value="+nodes.features[i].properties.Node_Number + ">" + nodes.features[i].properties.Node_Number + " - " + nodes.features[i].properties.Node_Name + "</option>");
                $('#ENode').selectpicker('refresh');
            	latmean += nodes.features[i].geometry.coordinates[1];
                longmean += nodes.features[i].geometry.coordinates[0];
            }
            latmean /= i;
            longmean /= i;
            map.setView([latmean, longmean], 11);

			nodelayer = L.geoJson(nodes,{
                 pointToLayer: function (feature, latlng) {
            		return L.circleMarker(latlng, geojsonMarkerOptions);
        		 },
        		 onEachFeature:function(feature,layer){
{#						layer.on(#}
{#							{#}
{#								mouseover:highlightFeature,#}
{#								mouseout:resetHighlight,#}
{#								click: function(){#}
{#										$('#select_tmc2 option:selected').removeAttr('selected');#}
{#										$('#select_tmc2').find("option[value='" + layer.feature.properties.TMC +"']").attr('selected', true);#}
{#										}#}
{#							});#}
						layer.bindPopup("Corridor : " + feature.properties.Corridor_Number + " - " + feature.properties.Corridor_Name +
									"<br>Node : " + feature.properties.Node_Number+ " - " + feature.properties.Node_Name + "<br>Latitude : "
                        			+ feature.geometry.coordinates[1] + "<br>Longitude : " + feature.geometry.coordinates[0]);
						}
            }).addTo(map);
			control.addOverlay(nodelayer, "Corridor " + String(cornum));
        }, 'json');
    }

    cornum0 = $('#cor option:selected').attr('value');
    corchange(cornum0);
    $('#cor').change(function(){
        cornum0 = $('#cor option:selected').attr('value');
        corchange(cornum0);
    });

    var geojsonMarkerOptionsSnode = {
        radius: 11,
        fillColor: "green",
        color: "green",
        weight: 5,
        opacity: 0.3,
        fillOpacity: 0.8
    };

    function snodechange(Snodenum){
        if(Snodelayer){
					control.removeLayer(Snodelayer);
					if(map.hasLayer(Snodelayer)){
						map.removeLayer(Snodelayer);
					}
				}
        $('#spctravel_time_car').text('');
		$('#spctravel_delay').text('');
        $("#chart").empty();
        for (var i=0;i<nodes.features.length;i++){
            if (nodes.features[i].properties.Node_Number == Snodenum){
                resultSnode = nodes.features[i];
                break;
            }
        }
        Snodelayer = L.geoJson(resultSnode,{
                 pointToLayer: function (feature, latlng) {
            		return L.circleMarker(latlng, geojsonMarkerOptionsSnode);
        		 },
        		 onEachFeature:function(feature,layer){
						layer.bindPopup("Corridor : " + feature.properties.Corridor_Number + " - " + feature.properties.Corridor_Name +
									"<br>Node : " + feature.properties.Node_Number+ " - " + feature.properties.Node_Name + "<br>Latitude : "
                        			+ feature.geometry.coordinates[1] + "<br>Longitude : " + feature.geometry.coordinates[0]);
						}
        }).addTo(map);
        map.setView([resultSnode.geometry.coordinates[1], resultSnode.geometry.coordinates[0]], 12);
        control.addOverlay(Snodelayer, "Start Node: " + Snodenum);
    }

    Snodenum0 = $('#SNode option:selected').attr('value');
    $('#SNode').change(function(){
		Snodenum0 = $('#SNode option:selected').attr('value');
    	snodechange(Snodenum0);
    });

    var geojsonMarkerOptionsEnode = {
        radius: 11,
        fillColor: "red",
        color: "red",
        weight: 5,
        opacity: 0.3,
        fillOpacity: 0.8
    };

    function enodechange(Enodenum){
        if(Enodelayer){
					control.removeLayer(Enodelayer);
					if(map.hasLayer(Enodelayer)){
						map.removeLayer(Enodelayer);
					}
				}
        $('#spctravel_time_car').text('');
		$('#spctravel_delay').text('');
        $("#chart").empty();
        for (var i=0;i<nodes.features.length;i++){
            if (nodes.features[i].properties.Node_Number == Enodenum){
                resultEnode = nodes.features[i];
                break;
            }
        }
        Enodelayer = L.geoJson(resultEnode,{
                 pointToLayer: function (feature, latlng) {
            		return L.circleMarker(latlng, geojsonMarkerOptionsEnode);
        		 },
        		 onEachFeature:function(feature,layer){
						layer.bindPopup("Corridor : " + feature.properties.Corridor_Number + " - " + feature.properties.Corridor_Name +
									"<br>Node : " + feature.properties.Node_Number+ " - " + feature.properties.Node_Name + "<br>Latitude : "
                        			+ feature.geometry.coordinates[1] + "<br>Longitude : " + feature.geometry.coordinates[0]);
						}
        }).addTo(map);
        map.setView([resultEnode.geometry.coordinates[1], resultEnode.geometry.coordinates[0]], 12);
        control.addOverlay(Enodelayer, "End Node: " + Enodenum);
    }

    Enodenum0 = $('#ENode option:selected').attr('value');
    $('#ENode').change(function(){
        Enodenum0 = $('#ENode option:selected').attr('value');
    	enodechange(Enodenum0);
    });


    function plot(alltraveltime,alldelay,allindex,snode,enode,cor){

			$("#chart1").empty();
            $("#chart2").empty();

			var n = alldelay.length;
			var line1 = [], line2 = [];
            var mintravetime = 99999, maxtraveltime = -99999;
            var mindelay = 99999, maxdelay = -99999;
			for(var i=0;i<n;i++){
                var hour = parseInt(allindex[i]/4);
                var minute = parseInt((allindex[i]%4)*15);
                if(minute==0){
                    minute = "00";
                }
				var point1 = [""+hour+":"+minute,alltraveltime[i]];
                var point2 = [""+hour+":"+minute,alldelay[i]];
				line1.push(point1);
                line2.push(point2);
                if (alldelay[i] > maxdelay){ maxdelay = alldelay[i]}
                if (alltraveltime[i] > maxtraveltime){ maxtraveltime = alltraveltime[i]}
                if (alldelay[i] < mindelay){ mindelay = alldelay[i]}
                if (alltraveltime[i] < mintravetime){ mintravetime = alltraveltime[i]}
			}
            maxtraveltime = Math.ceil(maxtraveltime*1.2);
            mintravetime = Math.floor(mintravetime/1.5);
            maxdelay = Math.ceil(maxdelay*1.2);
            mindelay = -1;
			var plot1 = $.jqplot('chart1', [line1], {
    			title:'Average Travel Time between Nodes ' + snode + ' and ' + enode + ' on Corridor ' + cor + ' in a Typical Weekday between Year 2013-2015',
                seriesDefaults: {
                    pointLabels: { show:false, formatString: "%#.2f" }
                },
    			axes:{
    					xaxis:{label:'Time of the day', renderer:$.jqplot.DateAxisRenderer, tickOptions:{formatString:'%#H:%M'}, min:"0:00", max:"24:00"},
    					yaxis:{min:mintravetime, max:maxtraveltime, label:'Time\n(min)'}
    				},
    			//series:[{lineWidth:4, markerOptions:{style:'circle',size:6}}]
    			series:[
                    {color:'#5FAB78',label:'Traveltime',showLine:false },
{#                    {label:'Delay',showLine:false }#}
                ],
                legend: {
                    show: true,
                    location: 'se',     // compass direction, nw, n, ne, e, se, s, sw, w.
                    xoffset: 12,        // pixel offset of the legend box from the x (or x2) axis.
                    yoffset: 12        // pixel offset of the legend box from the y (or y2) axis.
                }
  			});

            var plot2 = $.jqplot('chart2', [line2], {
    			title:'Average Delay between Nodes ' + snode + ' and ' + enode + ' on Corridor ' + cor + ' in a Typical Weekday between Year 2013-2015',
                seriesDefaults: {
                    pointLabels: { show:false, formatString: "%#.2f" }
                },
    			axes:{
    					xaxis:{label:'Time of the day', renderer:$.jqplot.DateAxisRenderer, tickOptions:{formatString:'%#H:%M'}, min:"0:00", max:"24:00"},
    					yaxis:{min:mindelay, max:maxdelay, label:'Time\n(min)'}
    				},
    			//series:[{lineWidth:4, markerOptions:{style:'circle',size:6}}]
    			series:[
{#                    {color:'#5FAB78',label:'Traveltime',showLine:false },#}
                    {label:'Delay',showLine:false }
                ],
                legend: {
                    show: true,
                    location: 'se',     // compass direction, nw, n, ne, e, se, s, sw, w.
                    xoffset: 12,        // pixel offset of the legend box from the x (or x2) axis.
                    yoffset: 12        // pixel offset of the legend box from the y (or y2) axis.
                }
  			});
		}

    function getrange(time){
        temp = time.split(' ')[0];
        h = parseInt(temp.split(':')[0]);
        if (h == 12){h -= 12}
        m = parseInt(temp.split(':')[1]);
        ans = h * 4;
        if ((m > 7.5) && (m < 22.5)){ans += 1}
        else if ((m > 22.5) && (m < 37.5)){ans += 2}
        else if ((m > 37.5) && (m < 52.5)){ans += 3}
        else if ((m > 52.5) && (m < 60)){ans += 4}
        if (time.split(' ')[1] == 'PM'){ans += 48}

        return ans
    }

	$('#datetimepicker').change(function(){
        $('#spctravel_time_car').text('');
		$('#spctravel_delay').text('');
    });

    $('#Etime').change(function(){
        $('#spctravel_time_car').text('');
		$('#spctravel_delay').text('');
    });

    $('#spcshow').click(function(){
        Stime = $('#Stime').val();
        Etime = $('#Etime').val();
        $.get('../get_spc_traveltime_2013to2015/', {cornum:cornum0,Snode:Snodenum0,Enode:Enodenum0}, function(data, textStatus){
			SpcOutput = $.parseJSON(data);
            finaltraveltime = 0;
            finaldelay = 0;
            counttraveltime = 0;
            countdelay = 0;
            tmin = getrange(Stime);
            tmax = getrange(Etime) + 1;
            if (tmin < tmax) {
                for (var i = tmin; i < tmax; i++) {
                    if (SpcOutput[i].spctraveltime != "NULL") {
                        finaltraveltime += parseFloat(SpcOutput[i].spctraveltime);
                        counttraveltime += 1
                    }
                    if (SpcOutput[i].spcdelay != "NULL") {
                        finaldelay += parseFloat(SpcOutput[i].spcdelay);
                        countdelay += 1
                    }
                }
                if (finaltraveltime == 0) {
                    $('#spctravel_time_car').text("Data Not Available");
                }
                else {
                    finaltraveltime /= counttraveltime;
                    $('#spctravel_time_car').text(String(finaltraveltime).substring(0, 5) + " Minutes");
                }
                if (finaldelay == 0) {
                    $('#spctravel_delay').text("Data Not Available");
                }
                else {
                    finaldelay /= countdelay;
                    $('#spctravel_delay').text(String(finaldelay).substring(0, 5) + " Minutes");
                }
            } else {alert('Start Time must be ealier than End Time!\n\nPlease select another time period.')}

            //jqplot preparation:
            var alltraveltime = [], alldelay=[], allindex = [];
            for (var i=0;i<SpcOutput.length;i++) {
                if (SpcOutput[i].spctraveltime != "NULL" && SpcOutput[i].spcdelay != "NULL"){
                    alltraveltime.push(parseFloat(SpcOutput[i].spctraveltime));
                    alldelay.push(parseFloat(SpcOutput[i].spcdelay));
                    allindex.push(i);
                }
            }
            plot(alltraveltime,alldelay,allindex,Snodenum0,Enodenum0,cornum0);
        }, 'json');

    });
{#======================================================================================================================#}

    });
</script>

{% endblock %}


